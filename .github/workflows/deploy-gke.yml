name: Deploy to GKE

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GKE_CLUSTER: ${{ secrets.GKE_CLUSTER_NAME }}
  GKE_ZONE: ${{ secrets.GKE_ZONE }}
  REGISTRY: ${{ secrets.ARTIFACT_REGISTRY }}

jobs:
  build-and-deploy:
    name: Build and Deploy to GKE
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        install_components: 'gke-gcloud-auth-plugin'

    - name: Configure Docker for Artifact Registry
      run: |
        gcloud auth configure-docker us-central1-docker.pkg.dev

    - name: Get GKE credentials
      env:
        USE_GKE_GCLOUD_AUTH_PLUGIN: "True"
      run: |
        gcloud container clusters get-credentials $GKE_CLUSTER \
          --region $GKE_ZONE \
          --project $PROJECT_ID

    - name: Build and push Docker images
      run: |
        # Build all service images
        services=("web-ui" "api-mock" "policy-mock" "ingest-mock" "bridge-mock" "registry-mock" "runtime-mock")
        
        for service in "${services[@]}"; do
          echo "üî® Building $service..."
          
          if [ "$service" = "web-ui" ]; then
            docker build -f infra/docker/Dockerfile.web-ui \
              -t ${REGISTRY}/${service}:${GITHUB_SHA::7} \
              -t ${REGISTRY}/${service}:latest \
              .
          else
            docker build -f infra/docker/Dockerfile.${service} \
              -t ${REGISTRY}/${service}:${GITHUB_SHA::7} \
              -t ${REGISTRY}/${service}:latest \
              .
          fi
          
          echo "üì§ Pushing $service..."
          docker push ${REGISTRY}/${service}:${GITHUB_SHA::7}
          docker push ${REGISTRY}/${service}:latest
        done

    - name: Deploy to GKE with Helm
      env:
        USE_GKE_GCLOUD_AUTH_PLUGIN: "True"
      run: |
        # Create namespace if it doesn't exist
        kubectl create namespace agentos --dry-run=client -o yaml | kubectl apply -f -
        
        # Install/upgrade Helm release
        helm upgrade --install agentos-mock ./helm/agentos-mock \
          --namespace agentos \
          --set image.registry=${REGISTRY} \
          --set image.tag=${GITHUB_SHA::7} \
          --set postgresql.enabled=false \
          --set resources.requests.cpu=100m \
          --set resources.requests.memory=256Mi \
          --set resources.limits.cpu=1000m \
          --set resources.limits.memory=1Gi \
          --wait \
          --timeout 15m \
          --debug

    - name: Verify deployment
      env:
        USE_GKE_GCLOUD_AUTH_PLUGIN: "True"
      run: |
        kubectl get pods -n agentos
        kubectl get services -n agentos
        
    - name: Print access information
      run: |
        echo "üéâ Deployment complete!"
        echo ""
        echo "üìã Deployment Info:"
        echo "  - Commit SHA: ${GITHUB_SHA::7}"
        echo "  - Namespace: agentos"
        echo ""
        echo "üîç Check status:"
        echo "  kubectl get pods -n agentos"
        echo "  kubectl logs -n agentos -l app=web-ui"
        echo ""
        echo "üåê To access the application, run:"
        echo "  kubectl port-forward -n agentos svc/web-ui 8080:80"
